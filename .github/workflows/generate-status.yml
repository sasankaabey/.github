name: Update Status Gist

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout .github repo
        uses: actions/checkout@v3
        with:
          path: .github
          
      - name: Checkout home-assistant-config
        uses: actions/checkout@v3
        with:
          repository: sasankaabey/home-assistant-config
          path: ha-config
          
      - name: Generate status markdown
        run: |
          cat > status.md << 'MDEOF'
          # Kit Lab Works - Live Status
          
          *Auto-updated from GitHub â€¢ Last refresh: $(date -u '+%Y-%m-%d %H:%M UTC')*
          
          ---
          
          MDEOF
          
          # Parse TASKS.md from home-assistant-config
          if [ -f "ha-config/TASKS.md" ]; then
            echo "## ðŸ  Home Assistant" >> status.md
            echo "" >> status.md
            echo "[View Repository â†’](https://github.com/sasankaabey/home-assistant-config)" >> status.md
            echo "" >> status.md
            
            # Extract in-progress tasks
            echo "### ðŸ”„ Currently Working On" >> status.md
            echo "" >> status.md
            grep -A 5 "Status:\*\* In Progress" ha-config/TASKS.md | grep "^###" | sed 's/### /- /' >> status.md || echo "- Nothing in progress" >> status.md
            echo "" >> status.md
            
            # Extract completed tasks (last 3)
            echo "### âœ… Recently Completed" >> status.md
            echo "" >> status.md
            grep -A 5 "Status:\*\* Completed" ha-config/TASKS.md | grep "^###" | head -3 | sed 's/### /- /' >> status.md || echo "- No recent completions" >> status.md
            echo "" >> status.md
            
            # Count backlog
            backlog_count=$(grep -c "Status:\*\* Not Started" ha-config/TASKS.md || echo "0")
            echo "### ðŸ“‹ Backlog" >> status.md
            echo "" >> status.md
            echo "${backlog_count} tasks waiting" >> status.md
            echo "" >> status.md
          fi
          
          echo "---" >> status.md
          echo "" >> status.md
          echo "*Powered by [multi-agent workflow](https://github.com/sasankaabey/.github) â€¢ Updates every 6 hours*" >> status.md
          
      - name: Update gist
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_SECRET }}
          gist_id: 81767151e079753e16d249fe2d57bc47
          file_path: status.md
          file_type: text
